{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="bi bi-upload"></i> Convert Log File</h3>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="convertForm">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Log Type</label>
                                <select class="form-select" name="log_type" id="logType" required>
                                    <option value="CSV">CSV File</option>
                                    <option value="CAN">CAN Bus Log</option>
                                    <option value="ACCESSPORT">COBB Accessport Log</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Resampling Frequency (Hz)</label>
                                <input type="number" class="form-control" name="frequency" 
                                       value="10" min="1" max="1000" step="1">
                                <div class="form-text">Frequency for resampling all channels</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Log File</label>
                        <input type="file" class="form-control" name="log_file" accept=".log,.csv,.txt" required>
                        <div class="form-text" id="fileHelp">
                            Select your log file (CAN log, CSV, or Accessport CSV)
                        </div>
                    </div>

                    <div class="mb-4" id="dbcSection" style="display: none;">
                        <label class="form-label">DBC File (Required for CAN logs)</label>
                        <input type="file" class="form-control" name="dbc_file" accept=".dbc">
                        <div class="form-text">
                            CAN database file describing the structure of CAN frames
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Output Filename (Optional)</label>
                        <input type="text" class="form-control" name="output_filename" 
                               placeholder="Leave blank to use input filename">
                        <div class="form-text">Generated file will have .ld extension</div>
                    </div>

                    <!-- Metadata Section -->
                    <div class="accordion mb-4" id="metadataAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#metadataCollapse">
                                    <i class="bi bi-info-square me-2"></i> MoTeC Metadata (Optional)
                                </button>
                            </h2>
                            <div id="metadataCollapse" class="accordion-collapse collapse" 
                                 data-bs-parent="#metadataAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Driver</label>
                                            <input type="text" class="form-control" name="driver">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Vehicle ID</label>
                                            <input type="text" class="form-control" name="vehicle_id">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Vehicle Weight</label>
                                            <input type="text" class="form-control" name="vehicle_weight">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Vehicle Type</label>
                                            <input type="text" class="form-control" name="vehicle_type">
                                        </div>
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Vehicle Comment</label>
                                            <textarea class="form-control" name="vehicle_comment" rows="2"></textarea>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Venue Name</label>
                                            <input type="text" class="form-control" name="venue_name">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Event Name</label>
                                            <input type="text" class="form-control" name="event_name">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Event Session</label>
                                            <input type="text" class="form-control" name="event_session">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Short Comment</label>
                                            <input type="text" class="form-control" name="short_comment">
                                        </div>
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Long Comment</label>
                                            <textarea class="form-control" name="long_comment" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="bi bi-gear"></i> Convert to MoTeC .ld
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg ms-2">
                            <i class="bi bi-arrow-left"></i> Back
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-lg mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>CAN Logs:</strong> Must be in candump format (from can-utils package). DBC file is required.</li>
                    <li><strong>CSV Files:</strong> First column must be time in seconds.</li>
                    <li><strong>Accessport Logs:</strong> Use CSV files directly exported from COBB Accessport.</li>
                    <li>All data is resampled to a fixed frequency for MoTeC compatibility.</li>
                    <li>Generated .ld files are "Pro Enabled" and can be opened in i2 Standard or i2 Pro.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const logTypeSelect = document.getElementById('logType');
    const dbcSection = document.getElementById('dbcSection');
    const fileHelp = document.getElementById('fileHelp');
    
    function updateForm() {
        const logType = logTypeSelect.value;
        
        // Show/hide DBC section
        if (logType === 'CAN') {
            dbcSection.style.display = 'block';
            fileHelp.textContent = 'Select your CAN bus log file (candump format)';
        } else {
            dbcSection.style.display = 'none';
            if (logType === 'ACCESSPORT') {
                fileHelp.textContent = 'Select your COBB Accessport CSV file';
            } else {
                fileHelp.textContent = 'Select your CSV file (time in first column)';
            }
        }
        
        // Set required attribute on DBC file input
        const dbcInput = document.querySelector('input[name="dbc_file"]');
        if (logType === 'CAN') {
            dbcInput.required = true;
        } else {
            dbcInput.required = false;
        }
    }
    
    // Initial update
    updateForm();
    
    // Update on change
    logTypeSelect.addEventListener('change', updateForm);
    
    // Set log type from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const type = urlParams.get('type');
    if (type) {
        logTypeSelect.value = type.toUpperCase();
        updateForm();
    }
});
</script>
{% endblock %}